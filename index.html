<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de Concordancia Griega</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Usamos la fuente Inter para un look limpio y moderno */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        
        /* Estilo para las sugerencias (dropdown) */
        .suggestions {
            max-height: 200px;
            overflow-y: auto;
            border-top: none;
            z-index: 10;
        }
        .suggestion-item:hover {
            background-color: #e5e7eb;
        }
        /* Ocultar scrollbar en algunos navegadores */
        .suggestions::-webkit-scrollbar { width: 4px; }
        .suggestions::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }

        /* Estilo para las entradas del diccionario */
        .dict-entry-box {
            border-left: 4px solid #3b82f6;
            background-color: #eff6ff;
        }

        /* Estilo para el teclado (puede necesitar un ajuste fino) */
        .keyboard-key {
            user-select: none;
            cursor: pointer;
            @apply p-2 m-0.5 rounded-md bg-white shadow-sm transition hover:bg-gray-100 active:bg-blue-100;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">
    <div id="appContainer" class="max-w-4xl mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Buscador LexiS-G</h1>
        
        <!-- API URL Config (OCULTO para el usuario final, pero pre-llenado por el dueño) -->
        <div id="apiUrlConfig" class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg hidden">
            <label for="apiUrl" class="block text-sm font-medium text-yellow-800 mb-1">URL de tu API de Apps Script</label>
            <input type="text" id="apiUrl" placeholder="Pega aquí la URL de despliegue de tu App Script..."
                   class="w-full px-3 py-2 border border-yellow-300 rounded-lg text-sm focus:ring-yellow-500 focus:border-yellow-500 transition"
                   value="[PEGA_AQUÍ_LA_URL_DE_TU_APPS_SCRIPT]"
                   onchange="saveApiUrl()">
            <p class="text-xs text-yellow-700 mt-1">Este valor se guarda en tu navegador. Recuerda volver a desplegar tu script si lo cambias.</p>
        </div>

        <!-- Barra de búsqueda y sugerencias -->
        <div class="relative mb-6">
            <input type="text" id="queryInput" placeholder="Escribe la palabra griega (mínimo 2 letras)..."
                   class="w-full p-4 text-lg border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-blue-500 transition shadow-md"
                   autocomplete="off">
            <ul id="suggestionsList" class="suggestions absolute w-full bg-white border border-gray-300 rounded-b-xl shadow-lg mt-1 hidden"></ul>
            
            <button id="searchButton" 
                    class="absolute right-2 top-2.5 bg-blue-600 text-white p-2.5 rounded-lg hover:bg-blue-700 transition active:scale-95 shadow-md">
                Buscar
            </button>
        </div>

        <!-- Indicador de estado y carga -->
        <div id="statusMessage" class="text-center text-lg text-blue-600 font-semibold mb-6 p-3 rounded-lg bg-blue-50">
            Cargando...
        </div>

        <!-- Teclado Griego (Opcional, pero recomendado) -->
        <h2 class="text-xl font-semibold text-gray-700 mb-3 mt-8">Teclado Griego</h2>
        <div id="greekKeyboard" class="flex flex-wrap justify-center p-3 bg-gray-50 rounded-lg shadow-inner">
            <!-- Fila Alpha (con acentos) -->
            <div class="keyboard-key" data-char="α">α</div>
            <div class="keyboard-key" data-char="ά">ά</div>
            <div class="keyboard-key" data-char="ὰ">ὰ</div>
            <div class="keyboard-key" data-char="ἀ">ἀ</div>
            <div class="keyboard-key" data-char="ἁ">ἁ</div>
            <div class="keyboard-key" data-char="ᾶ">ᾶ</div>
            <div class="keyboard-key" data-char="ᾳ">ᾳ</div>
            <!-- Fila Epsilon, Eta, Iota -->
            <div class="keyboard-key" data-char="ε">ε</div>
            <div class="keyboard-key" data-char="έ">έ</div>
            <div class="keyboard-key" data-char="ὴ">ὴ</div>
            <div class="keyboard-key" data-char="η">η</div>
            <div class="keyboard-key" data-char="ή">ή</div>
            <div class="keyboard-key" data-char="ι">ι</div>
            <div class="keyboard-key" data-char="ί">ί</div>
            <div class="keyboard-key" data-char="ϊ">ϊ</div>
            <!-- Fila Omicron, Upsilon -->
            <div class="keyboard-key" data-char="ο">ο</div>
            <div class="keyboard-key" data-char="ό">ό</div>
            <div class="keyboard-key" data-char="υ">υ</div>
            <div class="keyboard-key" data-char="ύ">ύ</div>
            <div class="keyboard-key" data-char="ϋ">ϋ</div>
            <!-- Consonantes Comunes -->
            <div class="keyboard-key" data-char="σ">σ</div>
            <div class="keyboard-key" data-char="τ">τ</div>
            <div class="keyboard-key" data-char="ρ">ρ</div>
            <div class="keyboard-key" data-char="δ">δ</div>
            <div class="keyboard-key" data-char="λ">λ</div>
            <div class="keyboard-key" data-char="κ">κ</div>
            <!-- Otros signos -->
            <div class="keyboard-key bg-red-100 hover:bg-red-200" data-char="backspace">⌫</div>
        </div>

        <!-- Sección de Resultados (Diccionario y Concordancia) -->
        <div id="resultsContainer" class="mt-10">
            <!-- Resultados se inyectan aquí -->
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Resultados de la Búsqueda</h2>
        </div>
    </div>

    <script>
        // =========================================================================
        // 1. CONFIGURACIÓN Y ESTADO GLOBAL (Client-Side Caching)
        // =========================================================================
        const API_BASE_URL_KEY = 'greek_api_url';
        
        // Objeto para almacenar los datos grandes del diccionario y concordancia localmente
        let appData = {
            dictionary: {},
            concordance: [],
            isLoaded: false
        };

        const elements = {
            apiUrl: document.getElementById('apiUrl'),
            queryInput: document.getElementById('queryInput'),
            suggestionsList: document.getElementById('suggestionsList'),
            searchButton: document.getElementById('searchButton'),
            statusMessage: document.getElementById('statusMessage'),
            resultsContainer: document.getElementById('resultsContainer'),
            greekKeyboard: document.getElementById('greekKeyboard'),
        };

        // =========================================================================
        // 2. FUNCIONES HELPER (Portadas de Apps Script)
        // =========================================================================

        /**
         * Strip Diacritics (Helper Function)
         * Elimina acentos, espíritus, y subíndices iota del texto griego.
         * @param {string} text Texto griego con diacríticos.
         * @return {string} Texto griego sin diacríticos (normalizado).
         */
        function stripDiacritics(text) {
            // Usa la normalización NFKD
            let normalized = text.normalize('NFKD');
            
            // Elimina diacríticos combinados y espíritus griegos
            let stripped = normalized.replace(/[\u0300-\u036F\u1F00-\u1FFF]/g, function(match) {
                if (match === '\u0345') return ''; 
                return '';
            });
            
            // Limpieza adicional de caracteres especiales
            stripped = stripped.replace(/[\u0374-\u037E\u0384\u0385\u1FBC\u1FBE\u1FCF\u1FCD\u1FCC\u1FCE\u1FCB]/g, '');
            
            return stripped;
        }

        /**
         * Tokenize Text (Helper Function)
         * Limpia una cadena de texto de puntuación y la divide en un array de palabras.
         * @param {string} text Texto de un versículo.
         * @return {string[]} Array de palabras limpias.
         */
        function tokenizeText(text) {
            // Reemplaza la puntuación común con un espacio
            return text.replace(/[.,;:\u0387\u2022\u2019]/g, ' ') 
                        .split(/\s+/)
                        .filter(Boolean); // Elimina elementos vacíos
        }

        // =========================================================================
        // 3. LÓGICA DE CARGA Y CACHÉ (La pieza clave para la velocidad)
        // =========================================================================
        
        /** Guarda la URL de la API en el almacenamiento local */
        function saveApiUrl() {
            // Esta función ya no es relevante si la URL está hardcodeada, 
            // pero se mantiene para permitir la edición en caso de que se muestre el campo.
            localStorage.setItem(API_BASE_URL_KEY, elements.apiUrl.value.trim());
        }

        /** Llama a la API de Apps Script para obtener TODOS los datos (solo palabras para sugerencias) */
        async function fetchInitialData(url) {
            
            elements.statusMessage.textContent = "Cargando la lista de palabras del diccionario (puede tardar unos segundos la primera vez)...";

            // 1. Obtener el diccionario (lista de palabras)
            const listUrl = `${url}?action=getFullDictionary&callback=callback`;
            const wordListPromise = fetch(listUrl)
                .then(response => response.text())
                .then(text => {
                    const jsonMatch = text.match(/callback\(([\s\S]*)\)/);
                    return jsonMatch ? JSON.parse(jsonMatch[1]) : [];
                })
                .then(list => {
                    const dictionaryMap = {};
                    list.forEach(item => {
                        dictionaryMap[item.palabra] = item.estado;
                    });
                    return dictionaryMap;
                });

            // 2. Ejecutar la promesa y guardar
            const dictionaryMap = await wordListPromise;
            
            appData.dictionary = dictionaryMap;
            appData.isLoaded = true;

            // Guardar la lista de palabras en sessionStorage 
            sessionStorage.setItem('dictionary_words_list', JSON.stringify(Object.keys(dictionaryMap)));

            return true; 
        }

        /**
         * Inicializa la aplicación, intentando cargar los datos de caché del navegador.
         */
        async function loadData() {
            // La URL se carga del HTML (pre-llenada por el dueño) o de localStorage
            let storedApiUrl = elements.apiUrl.value.trim();
            
            // Si el dueño no ha cambiado el placeholder, intenta leer de localStorage por si acaso
            if (storedApiUrl === '[https://script.google.com/macros/s/AKfycbzAYgewlUCnedtbPhhJf9ajgX_94pXbM8E06ZSPPejXj0SIqIYaQ1v0_DTqea_wO2LE/exec]') {
                storedApiUrl = localStorage.getItem(API_BASE_URL_KEY);
                if (storedApiUrl) {
                    elements.apiUrl.value = storedApiUrl;
                }
            }
            
            if (!elements.apiUrl.value || elements.apiUrl.value === '[PEGA_AQUÍ_LA_URL_DE_TU_APPS_SCRIPT]') {
                // Si el dueño olvidó pegarla, mostramos el campo para que lo haga.
                document.getElementById('apiUrlConfig').classList.remove('hidden');
                elements.statusMessage.textContent = "ADVERTENCIA: El dueño de la aplicación debe pegar la URL de la API en el campo superior antes de usar.";
                return;
            }
            
            // 1. Intentar cargar desde la caché del navegador
            const cachedWordsList = sessionStorage.getItem('dictionary_words_list');

            if (cachedWordsList) {
                // Éxito en caché del navegador
                elements.statusMessage.textContent = "Datos cargados desde la caché del navegador. ¡Sugerencias instantáneas!";
                const words = JSON.parse(cachedWordsList);
                words.forEach(word => {
                    appData.dictionary[word] = true; // Solo necesitamos la clave
                });
                appData.isLoaded = true;
                elements.queryInput.disabled = false;
                elements.searchButton.disabled = false;
                return;
            }

            // 2. Fallo de caché: Cargar de la API (Lento)
            elements.queryInput.disabled = true;
            elements.searchButton.disabled = true;

            try {
                await fetchInitialData(elements.apiUrl.value.trim());
                elements.statusMessage.textContent = "Carga inicial completada. ¡Busca ahora!";
                elements.statusMessage.classList.remove('bg-blue-50', 'text-blue-600');
                elements.statusMessage.classList.add('bg-green-100', 'text-green-600');

            } catch (error) {
                console.error("Error al cargar datos iniciales:", error);
                elements.statusMessage.textContent = "ERROR de carga. Asegúrate de que la URL de la API es correcta y has desplegado el script. Detalles en consola.";
                elements.statusMessage.classList.remove('bg-blue-50', 'text-blue-600');
                elements.statusMessage.classList.add('bg-red-100', 'text-red-600');
            } finally {
                elements.queryInput.disabled = false;
                elements.searchButton.disabled = false;
            }
        }

        // =========================================================================
        // 4. LÓGICA DE SUGERENCIAS Y BÚSQUEDA LOCAL
        // =========================================================================

        /** Genera sugerencias usando los datos almacenados localmente. (INSTANTÁNEO) */
        function getSuggestionsLocal(query) {
            if (!appData.isLoaded || query.length < 2) {
                return [];
            }
            const normalizedQuery = stripDiacritics(query.toLowerCase().trim());
            let suggestions = [];
            const MAX_SUGGESTIONS = 20;

            for (let word in appData.dictionary) {
                // 1. Normalizar la palabra del diccionario (sin diacríticos)
                const normalizedWord = stripDiacritics(word).toLowerCase();

                // 2. Usamos startsWith() en el cliente
                if (normalizedWord.startsWith(normalizedQuery)) {
                    suggestions.push(word);
                    if (suggestions.length >= MAX_SUGGESTIONS) {
                        break; 
                    }
                }
            }
            suggestions.sort();
            return suggestions;
        }

        /** * Maneja el cambio en el input y muestra sugerencias. 
         * ¡Esta función ahora es INSTANTÁNEA!
         */
        function handleInput() {
            const query = elements.queryInput.value;
            if (query.length < 2) {
                elements.suggestionsList.innerHTML = '';
                elements.suggestionsList.classList.add('hidden');
                return;
            }

            const suggestions = getSuggestionsLocal(query);
            
            elements.suggestionsList.innerHTML = '';
            
            if (suggestions.length > 0) {
                suggestions.forEach(suggestion => {
                    const li = document.createElement('li');
                    li.textContent = suggestion;
                    li.className = 'suggestion-item p-3 cursor-pointer text-gray-700 hover:bg-gray-100 transition';
                    li.onclick = () => {
                        elements.queryInput.value = suggestion;
                        elements.suggestionsList.classList.add('hidden');
                        searchWord(suggestion);
                    };
                    elements.suggestionsList.appendChild(li);
                });
                elements.suggestionsList.classList.remove('hidden');
            } else {
                elements.suggestionsList.classList.add('hidden');
            }
        }
        
        /**
         * Llama a la API de Apps Script para la búsqueda real (lenta, pero necesaria).
         */
        async function searchWord(word) {
            if (!elements.apiUrl.value) {
                elements.statusMessage.textContent = "Por favor, introduce la URL de la API.";
                return;
            }
            if (!word) {
                word = elements.queryInput.value.trim();
            }
            if (!word) return;

            // 1. Mostrar estado de búsqueda
            elements.resultsContainer.innerHTML = `<p class="text-xl text-center text-blue-600">Buscando '${word}' en la API (esto puede tardar unos segundos)...</p>`;
            
            const apiUrl = elements.apiUrl.value.trim();
            const searchUrl = `${apiUrl}?word=${encodeURIComponent(word)}&mode=loose&callback=callback`;

            // 2. Llamar a la API
            try {
                const response = await fetch(searchUrl);
                const text = await response.text();
                
                // Extraer JSON de JSONP: callback([...])
                const jsonMatch = text.match(/callback\(([\s\S]*)\)/);
                const data = jsonMatch ? JSON.parse(jsonMatch[1]) : null;

                // 3. Renderizar Resultados
                renderResults(word, data);
            } catch (error) {
                console.error("Error al buscar palabra:", error);
                elements.resultsContainer.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-lg">Error de conexión con la API. Verifica la URL y la consola.</div>`;
            }
            
            elements.suggestionsList.classList.add('hidden');
        }

        /**
         * Renderiza la información del diccionario y la concordancia.
         */
        function renderResults(word, data) {
            let html = `<h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Resultados para: ${word}</h2>`;
            
            if (!data) {
                elements.resultsContainer.innerHTML = html + `<p class="text-gray-500">Error: No se pudo obtener la respuesta de la API.</p>`;
                return;
            }

            // 1. Información del Diccionario
            if (data.dictionaryInfo) {
                html += `
                    <div class="dict-entry-box p-4 mb-8 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-blue-700 mb-3">Definición y Estado (Diccionario)</h3>
                        <div class="text-gray-700">${data.dictionaryInfo}</div>
                    </div>
                `;
            } else {
                html += `<p class="p-3 mb-6 bg-yellow-100 text-yellow-800 rounded-lg">No se encontró una entrada 'Completada' para esta palabra en el diccionario.</p>`;
            }

            // 2. Concordancia
            if (data.concordance && data.concordance.length > 0) {
                html += `
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">${data.concordance.length} Concordancias Encontradas</h3>
                    <ul class="space-y-3">
                `;
                data.concordance.forEach(verse => {
                    html += `
                        <li class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <span class="font-mono text-sm text-gray-600">${verse.encabezado}</span>
                            <p class="mt-1 text-gray-800">${verse.versiculo}</p>
                        </li>
                    `;
                });
                html += `</ul>`;
            } else {
                 html += `<p class="p-3 bg-red-100 text-red-700 rounded-lg">No se encontraron coincidencias en la concordancia para la palabra '${word}'.</p>`;
            }

            elements.resultsContainer.innerHTML = html;
        }


        // =========================================================================
        // 5. MANEJO DE EVENTOS
        // =========================================================================
        
        function handleKeyboardClick(event) {
            const char = event.target.getAttribute('data-char');
            if (!char) return;

            let currentQuery = elements.queryInput.value;

            if (char === 'backspace') {
                elements.queryInput.value = currentQuery.slice(0, -1);
            } else {
                elements.queryInput.value += char;
            }
            handleInput(); // Actualiza sugerencias
        }

        // Event Listeners
        window.onload = loadData;
        elements.queryInput.addEventListener('input', handleInput);
        elements.searchButton.addEventListener('click', () => searchWord());
        elements.queryInput.addEventListener('keypress', (e) => {
             if (e.key === 'Enter') {
                elements.suggestionsList.classList.add('hidden');
                searchWord();
            }
        });
        elements.greekKeyboard.addEventListener('click', handleKeyboardClick);

        // Ocultar sugerencias al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (!elements.queryInput.contains(e.target) && !elements.suggestionsList.contains(e.target)) {
                elements.suggestionsList.classList.add('hidden');
            }
        });

    </script>
</body>
</html>
